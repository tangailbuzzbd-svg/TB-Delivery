
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .toast-enter { opacity: 0; transform: translateY(20px) scale(0.95); }
        .toast-enter-active { opacity: 1; transform: translateY(0) scale(1); transition: opacity 300ms, transform 300ms; }
        .toast-exit-active { opacity: 0; transform: translateY(20px) scale(0.95); transition: opacity 300ms, transform 300ms; }
        
        /* Modal styles */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-hidden {
            pointer-events: none;
        }
        .modal-hidden .modal-backdrop {
            opacity: 0;
        }
        .modal-hidden .modal-content {
            opacity: 0;
            transform: scale(0.95) translateY(20px);
        }
        /* Tab styles */
        .tab-active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        /* Custom Flatpickr styles */
        .flatpickr-input {
            cursor: pointer;
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #1f2937 !important; /* text-gray-800 */
        }
        .dark .flatpickr-input {
            background-color: #374151 !important; /* dark:bg-gray-700 */
            color: #ffffff !important; /* dark:text-white */
        }
        /* Flatpickr calendar dark mode */
        .dark .flatpickr-calendar {
            background: #1f2937 !important;
            border-color: #374151 !important;
        }
        .dark .flatpickr-months {
            background: #111827 !important;
        }
        .dark .flatpickr-current-month {
            color: #ffffff !important;
        }
        .dark .flatpickr-weekdays {
            background: #111827 !important;
        }
        .dark .flatpickr-weekday {
            color: #9ca3af !important;
        }
        .dark .flatpickr-day {
            color: #e5e7eb !important;
        }
        .dark .flatpickr-day:hover {
            background: #374151 !important;
        }
        .dark .flatpickr-day.selected {
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
        .dark .flatpickr-day.today {
            border-color: #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="flex flex-col items-center justify-center min-h-screen">
        <div class="w-16 h-16 border-4 border-t-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
        <p id="loading-message" class="mt-4 text-gray-600 dark:text-gray-300">Initializing...</p>
    </div>
    
    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Delivery Login</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Access your assigned orders</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700 dark:text-gray-300 block mb-1">Email Address</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="you@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700 dark:text-gray-300 block mb-1">Password</label>
                    <input type="password" id="password" name="password" required class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <p id="login-error" class="text-sm text-red-500 text-center min-h-[1.25rem]"></p>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-800 focus:ring-blue-500 transition-colors duration-200 transform active:scale-95">LOGIN</button>
            </form>
        </div>
    </div>


    <!-- Main Application -->
    <div id="app-container" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10 border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-2 sm:py-3 flex justify-between items-center gap-2">
                <h1 class="text-base sm:text-xl lg:text-2xl font-bold text-gray-800 dark:text-white truncate">Delivery Dashboard</h1>
                <div class="flex items-center gap-2 sm:gap-3 md:gap-4">
                    <!-- Notification Bell -->
                    <button id="notification-bell" class="relative flex-shrink-0 w-9 h-9 sm:w-10 sm:h-10 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i data-lucide="bell" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-600 dark:text-gray-300"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full items-center justify-center font-bold opacity-0 pointer-events-none" style="display: flex;">0</span>
                    </button>
                    <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 text-right hidden md:block">Welcome,<br><span id="delivery-man-name" class="font-semibold text-gray-800 dark:text-white"></span></p>
                    <button id="profile-button" class="flex-shrink-0 w-9 h-9 sm:w-10 sm:h-10 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                        <i data-lucide="user" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-600 dark:text-gray-300"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-6">
            <div id="dashboard-content">
                 <div class="mb-4 sm:mb-6 bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-lg shadow-sm text-center">
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-2 mb-3">
                       <label for="collection-date" class="text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Stats & History for:</label>
                       <input type="text" id="collection-date" placeholder="Select a date..." class="border border-gray-300 dark:border-gray-600 rounded-md p-1.5 text-xs sm:text-sm text-gray-800 dark:text-white bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer w-full sm:w-auto max-w-xs">
                    </div>
                     <div class="grid grid-cols-2 divide-x dark:divide-gray-700 mt-2">
                        <div class="p-2 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mb-1">COD Collection</p>
                            <p id="total-collection-info" class="text-lg sm:text-2xl font-bold text-green-600 dark:text-green-400">‡ß≥0</p>
                        </div>
                        <div class="p-2 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mb-1">Total Deliveries</p>
                            <p id="total-deliveries-info" class="text-lg sm:text-2xl font-bold text-blue-600 dark:text-blue-400">0</p>
                        </div>
                    </div>
                 </div>
                 
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="view-title" class="text-xl font-semibold text-gray-800 dark:text-gray-200">Current Orders</h2>
                    <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 disabled:opacity-50" title="Refresh View">
                        <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="mb-4 flex justify-center p-1 bg-gray-200 dark:bg-gray-800 rounded-lg gap-1">
                    <button id="current-orders-tab" class="flex-1 py-2 px-2 sm:px-4 text-xs sm:text-sm font-semibold rounded-md transition-colors duration-300 tab-active">
                        <span class="hidden sm:inline">Current Orders</span>
                        <span class="sm:hidden">Orders</span>
                    </button>
                    <button id="scan-qr-tab" class="flex-1 py-2 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 rounded-md transition-colors duration-300">
                        <span class="hidden sm:inline">Scan QR Code</span>
                        <span class="sm:hidden">QR Scan</span>
                    </button>
                    <button id="history-tab" class="flex-1 py-2 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 rounded-md transition-colors duration-300">
                        <span class="hidden sm:inline">Delivery History</span>
                        <span class="sm:hidden">History</span>
                    </button>
                </div>

                <div id="order-list" class="space-y-4">
                    <!-- Current orders will be dynamically inserted here -->
                </div>
                
                <!-- QR Code Scanner Section -->
                <div id="qr-scanner-section" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 rounded-full mx-auto flex items-center justify-center mb-4">
                                <i data-lucide="scan-line" class="w-10 h-10 text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Scan QR Code to Confirm Delivery</h3>
                            <p class="text-gray-600 dark:text-gray-400">Use your camera to scan the QR code on the shipping label</p>
                        </div>

                        <div class="max-w-2xl mx-auto">
                            <!-- Tab Switcher -->
                            <div class="flex mb-4 bg-gray-100 dark:bg-gray-700 rounded-lg p-1 gap-1">
                                <button id="camera-tab-btn" class="flex-1 py-2 px-2 sm:px-4 rounded-md bg-blue-600 text-white text-xs sm:text-sm font-semibold transition-colors">
                                    <i data-lucide="camera" class="w-3.5 h-3.5 sm:w-4 sm:h-4 inline mr-1 sm:mr-2"></i>
                                    <span class="hidden sm:inline">Camera Scanner</span>
                                    <span class="sm:hidden">Camera</span>
                                </button>
                                <button id="manual-tab-btn" class="flex-1 py-2 px-2 sm:px-4 rounded-md text-gray-600 dark:text-gray-300 text-xs sm:text-sm font-semibold transition-colors">
                                    <i data-lucide="keyboard" class="w-3.5 h-3.5 sm:w-4 sm:h-4 inline mr-1 sm:mr-2"></i>
                                    <span class="hidden sm:inline">Manual Entry</span>
                                    <span class="sm:hidden">Manual</span>
                                </button>
                            </div>

                            <!-- Camera Scanner -->
                            <div id="camera-scanner-view">
                                <div id="qr-reader" class="rounded-lg overflow-hidden border-2 border-gray-300 dark:border-gray-600 mb-4" style="width: 100%;"></div>
                                <div class="flex gap-2 justify-center mb-4">
                                    <button id="start-scan-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors flex items-center gap-2">
                                        <i data-lucide="play" class="w-5 h-5"></i>
                                        Start Camera
                                    </button>
                                    <button id="stop-scan-btn" class="hidden">
                                        <i data-lucide="square" class="w-5 h-5"></i>
                                        Stop Camera
                                    </button>
                                </div>
                            </div>

                            <!-- Manual Entry -->
                            <div id="manual-entry-view" class="hidden">
                                <label for="qr-scan-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Enter Order ID
                                </label>
                                <div class="flex gap-2">
                                    <input 
                                        type="text" 
                                        id="qr-scan-input"
                                        placeholder="Enter Order ID manually..."
                                        class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                    <button 
                                        id="confirm-scan-btn"
                                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors flex items-center gap-2"
                                    >
                                        <i data-lucide="check" class="w-5 h-5"></i>
                                        Confirm
                                    </button>
                                </div>
                            </div>
                            
                            <div id="qr-scan-result" class="hidden mt-4"></div>
                        </div>

                        <div class="mt-8 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800 max-w-2xl mx-auto">
                            <h4 class="font-semibold text-blue-900 dark:text-blue-200 mb-2 flex items-center gap-2">
                                <i data-lucide="info" class="w-5 h-5"></i>
                                Instructions
                            </h4>
                            <ul class="text-sm text-blue-800 dark:text-blue-300 space-y-1 list-disc list-inside">
                                <li>Click "Start Camera" to activate QR code scanner</li>
                                <li>Point your camera at the QR code on the shipping label</li>
                                <li>The scanner will automatically detect and process the code</li>
                                <li>You will be prompted to take a delivery photo</li>
                                <li>Alternatively, use "Manual Entry" tab to type the Order ID</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div id="history-list" class="hidden space-y-4">
                    <!-- History orders will be dynamically inserted here -->
                </div>
            </div>
        </main>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal-content relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4 p-6">
            <div class="text-center">
                <i data-lucide="bell-ring" class="w-12 h-12 mx-auto text-blue-500"></i>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mt-4">New Order Assigned!</h3>
                <div id="new-order-details" class="text-left mt-4 text-sm text-gray-600 dark:text-gray-300 space-y-2">
                    <!-- New order details will be injected here -->
                </div>
            </div>
            <div class="mt-6">
                <button id="accept-order-btn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition">Accept Order</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal-content relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm m-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white">My Profile</h3>
                <button id="close-profile-modal-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="text-center mb-6">
                <div class="w-24 h-24 rounded-full bg-blue-100 dark:bg-blue-900 mx-auto flex items-center justify-center mb-3">
                     <i data-lucide="bike" class="w-12 h-12 text-blue-500"></i>
                </div>
                <p id="profile-name" class="text-xl font-semibold text-gray-800 dark:text-white"></p>
                <p id="profile-email" class="text-sm text-gray-500 dark:text-gray-400"></p>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Phone Number</span>
                    <span id="profile-phone" class="font-bold text-gray-800 dark:text-white">N/A</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Vehicle</span>
                    <span id="profile-vehicle" class="font-bold text-gray-800 dark:text-white">N/A</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Account Status</span>
                    <span id="profile-status" class="font-bold text-gray-800 dark:text-white">N/A</span>
                </div>
                
                <!-- Theme Toggle -->
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <div class="flex items-center gap-2">
                        <i data-lucide="palette" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i>
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Theme</span>
                    </div>
                    <button id="profile-theme-toggle" class="flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                        <i data-lucide="sun" class="w-4 h-4 text-gray-800 dark:text-gray-200 hidden dark:block"></i>
                        <i data-lucide="moon" class="w-4 h-4 text-gray-800 dark:text-gray-200 block dark:hidden"></i>
                        <span class="text-xs font-medium text-gray-800 dark:text-gray-200 hidden dark:inline">Light</span>
                        <span class="text-xs font-medium text-gray-800 dark:text-gray-200 dark:hidden">Dark</span>
                    </button>
                </div>
                
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Total Orders Delivered</span>
                    <span id="profile-total-orders" class="font-bold text-gray-800 dark:text-white">0</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Total COD Collected</span>
                    <span id="profile-total-cod" class="font-bold text-gray-800 dark:text-white">‡ß≥0</span>
                </div>
            </div>

            <button id="logout-button-modal" class="w-full flex items-center justify-center gap-2 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-800 focus:ring-red-500 transition-colors duration-200 transform active:scale-95">
                 <i data-lucide="log-out" class="w-4 h-4"></i>
                 <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Delivery Confirmation Modal (QR Scan + Photo) -->
    <div id="delivery-confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal-content relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl m-4 p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Confirm Delivery</h3>
                <button id="close-delivery-confirmation-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="delivery-confirmation-content">
                <!-- Step 1: QR Scan -->
                <div id="qr-scan-step" class="space-y-4">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <div class="flex items-start gap-3">
                            <i data-lucide="alert-circle" class="w-6 h-6 text-blue-600 dark:text-blue-400 mt-0.5"></i>
                            <div>
                                <h4 class="font-semibold text-blue-900 dark:text-blue-200 mb-1">Scan QR Code to Verify</h4>
                                <p class="text-sm text-blue-800 dark:text-blue-300">Please scan the QR code on the shipping label to confirm this delivery.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Order ID:</p>
                        <p id="confirm-order-id" class="text-lg font-bold text-gray-800 dark:text-white font-mono">#...</p>
                    </div>

                    <!-- QR Reader -->
                    <div id="qr-reader-confirm" class="rounded-lg overflow-hidden border-2 border-gray-300 dark:border-gray-600" style="width: 100%;"></div>
                    
                    <div class="flex gap-2 justify-center">
                        <button id="start-scan-confirm-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors flex items-center gap-2">
                            <i data-lucide="camera" class="w-5 h-5"></i>
                            Start QR Scanner
                        </button>
                        <button id="stop-scan-confirm-btn" class="hidden">
                            <i data-lucide="square" class="w-5 h-5"></i>
                            Stop Scanner
                        </button>
                    </div>

                    <div id="qr-scan-status" class="hidden"></div>
                </div>

                <!-- Step 2: Photo Upload (Hidden initially) -->
                <div id="photo-upload-step" class="hidden space-y-4">
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600 dark:text-green-400 mt-0.5"></i>
                            <div>
                                <h4 class="font-semibold text-green-900 dark:text-green-200 mb-1">QR Code Verified!</h4>
                                <p class="text-sm text-green-800 dark:text-green-300">Now take a photo as proof of delivery.</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i data-lucide="camera" class="w-4 h-4 inline mr-1"></i>
                            Delivery Photo
                        </label>
                        <input type="file" id="delivery-photo-confirm" accept="image/*" capture="environment" 
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/50 dark:file:text-blue-200 cursor-pointer">
                    </div>

                    <div id="photo-preview" class="hidden">
                        <img id="photo-preview-img" src="" alt="Preview" class="w-full h-auto max-h-64 object-contain rounded-lg border-2 border-gray-300 dark:border-gray-600">
                    </div>

                    <div class="flex gap-2">
                        <button id="upload-confirm-btn" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="upload" class="w-5 h-5"></i>
                            Complete Delivery
                        </button>
                        <button id="skip-photo-confirm-btn" class="px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 font-semibold transition-colors">
                            Skip Photo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Contact Banner -->
    <div id="emergency-banner" class="fixed bottom-16 sm:bottom-20 left-0 right-0 bg-red-600 text-white py-2 px-3 sm:px-4 z-40 hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-2">
            <div class="flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm">
                <i data-lucide="alert-circle" class="w-3.5 h-3.5 sm:w-4 sm:h-4 flex-shrink-0"></i>
                <span class="hidden sm:inline">Emergency Contact</span>
                <span class="sm:hidden">Emergency</span>
            </div>
            <a href="tel:01863205976" class="flex items-center gap-1.5 sm:gap-2 bg-white/20 hover:bg-white/30 px-2 sm:px-3 py-1 rounded transition-colors flex-shrink-0">
                <i data-lucide="phone" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                <span class="font-bold text-xs sm:text-sm">01863205976</span>
            </a>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl mx-2 sm:mx-4 max-h-[90vh] sm:max-h-[80vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-3 sm:p-4 flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <i data-lucide="message-circle" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    <h3 class="text-base sm:text-lg font-bold">Messages from Admin</h3>
                </div>
                <button id="close-notification-modal" class="p-1 hover:bg-white/10 rounded transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Messages Container -->
            <div id="notification-messages" class="overflow-y-auto max-h-[calc(90vh-60px)] sm:max-h-[calc(80vh-60px)] divide-y dark:divide-gray-700">
                <div class="p-8 text-center text-gray-500">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                    <p>No messages yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="reply-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center p-4" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full mx-4">
            <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-4 flex items-center justify-between rounded-t-xl">
                <h3 class="text-base sm:text-lg font-bold">Reply to Admin</h3>
                <button id="close-reply-modal" class="p-1 hover:bg-white/10 rounded">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Your Reply:</label>
                    <textarea 
                        id="reply-message" 
                        rows="4" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none text-sm"
                        placeholder="Type your reply (Bengali/English)..."
                    ></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><span id="reply-char-count">0</span> / 300 characters</p>
                </div>
                <div class="flex gap-2">
                    <button id="cancel-reply-btn" class="flex-1 px-4 py-2.5 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg font-medium transition-colors text-sm">
                        Cancel
                    </button>
                    <button id="send-reply-btn" class="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Send Reply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 toast-enter z-50">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, getDoc, updateDoc, setDoc, serverTimestamp, GeoPoint } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Global Config & Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyC3Y_vUl_fG_lRc-dhWnrNVlmC7BwJ1KSg",
            authDomain: "tangailbuzz-com.firebaseapp.com",
            projectId: "tangailbuzz-com",
            storageBucket: "tangailbuzz-com.firebasestorage.app",
            messagingSenderId: "163495913951",
            appId: "1:163495913951:web:76d2a9689ef53d61b8bc6a",
            measurementId: "G-NZNM37VHDY"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        console.log('Firebase initialized successfully');
        console.log('Auth instance:', auth);
        console.log('Firestore instance:', db);

        // --- Theme Initialization (Must run BEFORE any UI rendering) ---
        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        console.log('üé® Theme initialized:', currentTheme);

        // --- UI Elements & State ---
        const ui = {
            loadingSpinner: document.getElementById('loading-spinner'),
            loadingMessage: document.getElementById('loading-message'),
            loginScreen: document.getElementById('login-screen'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            appContainer: document.getElementById('app-container'),
            deliveryManName: document.getElementById('delivery-man-name'),
            orderList: document.getElementById('order-list'),
            historyList: document.getElementById('history-list'),
            qrScannerSection: document.getElementById('qr-scanner-section'),
            currentOrdersTab: document.getElementById('current-orders-tab'),
            scanQrTab: document.getElementById('scan-qr-tab'),
            historyTab: document.getElementById('history-tab'),
            qrScanInput: document.getElementById('qr-scan-input'),
            confirmScanBtn: document.getElementById('confirm-scan-btn'),
            qrScanResult: document.getElementById('qr-scan-result'),
            cameraTabBtn: document.getElementById('camera-tab-btn'),
            manualTabBtn: document.getElementById('manual-tab-btn'),
            cameraScannerView: document.getElementById('camera-scanner-view'),
            manualEntryView: document.getElementById('manual-entry-view'),
            startScanBtn: document.getElementById('start-scan-btn'),
            stopScanBtn: document.getElementById('stop-scan-btn'),
            profileButton: document.getElementById('profile-button'),
            refreshButton: document.getElementById('refresh-button'),
            viewTitle: document.getElementById('view-title'),
            totalCollection: document.getElementById('total-collection-info'),
            totalDeliveries: document.getElementById('total-deliveries-info'),
            collectionDate: document.getElementById('collection-date'),
            newOrderModal: document.getElementById('new-order-modal'),
            newOrderDetails: document.getElementById('new-order-details'),
            acceptOrderBtn: document.getElementById('accept-order-btn'),
            profileModal: document.getElementById('profile-modal'),
            closeProfileModalBtn: document.getElementById('close-profile-modal-btn'),
            logoutButtonModal: document.getElementById('logout-button-modal'),
            profileName: document.getElementById('profile-name'),
            profileEmail: document.getElementById('profile-email'),
            profilePhone: document.getElementById('profile-phone'),
            profileVehicle: document.getElementById('profile-vehicle'),
            profileStatus: document.getElementById('profile-status'),
            profileTotalOrders: document.getElementById('profile-total-orders'),
            profileTotalCod: document.getElementById('profile-total-cod'),
            deliveryConfirmModal: document.getElementById('delivery-confirmation-modal'),
            closeDeliveryConfirmBtn: document.getElementById('close-delivery-confirmation-btn'),
            confirmOrderId: document.getElementById('confirm-order-id'),
            qrScanStep: document.getElementById('qr-scan-step'),
            photoUploadStep: document.getElementById('photo-upload-step'),
            startScanConfirmBtn: document.getElementById('start-scan-confirm-btn'),
            stopScanConfirmBtn: document.getElementById('stop-scan-confirm-btn'),
            qrScanStatus: document.getElementById('qr-scan-status'),
            deliveryPhotoConfirm: document.getElementById('delivery-photo-confirm'),
            photoPreview: document.getElementById('photo-preview'),
            photoPreviewImg: document.getElementById('photo-preview-img'),
            uploadConfirmBtn: document.getElementById('upload-confirm-btn'),
            skipPhotoConfirmBtn: document.getElementById('skip-photo-confirm-btn'),
            profileThemeToggle: document.getElementById('profile-theme-toggle'),
            // Notification elements
            notificationBell: document.getElementById('notification-bell'),
            notificationBadge: document.getElementById('notification-badge'),
            notificationModal: document.getElementById('notification-modal'),
            closeNotificationModal: document.getElementById('close-notification-modal'),
            notificationMessages: document.getElementById('notification-messages'),
            emergencyBanner: document.getElementById('emergency-banner'),
            // Reply modal elements
            replyModal: document.getElementById('reply-modal'),
            closeReplyModal: document.getElementById('close-reply-modal'),
            replyMessage: document.getElementById('reply-message'),
            replyCharCount: document.getElementById('reply-char-count'),
            cancelReplyBtn: document.getElementById('cancel-reply-btn'),
            sendReplyBtn: document.getElementById('send-reply-btn'),
        };

        let state = {
            unsubscribeOrders: null,
            unsubscribeDeliveryMan: null,
            liveTimerInterval: null,
            seenOrderIds: new Set(),
            isFirstLoad: true,
            newOrderQueue: [],
            audioContext: null,
            allOrders: [], // Holds the current list of all orders from Firestore
            currentUserData: null,
            html5QrCode: null, // QR Code scanner instance
            isScannerRunning: false,
            html5QrCodeConfirm: null, // Confirmation modal QR scanner
            isScannerRunningConfirm: false,
            pendingDeliveryOrderId: null, // Order ID waiting for delivery confirmation
            locationWatchId: null, // Geolocation watch ID
            lastLocation: null, // Last known location
            lastLocationUpdateTime: null, // Last Firestore update timestamp
            isOnline: false, // Online/Offline status
            // Notification state
            unsubscribeNotifications: null,
            unreadCount: 0,
            currentReplyMessageId: null,
        };
        
        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            try {
                ui.loadingSpinner.classList.add('hidden');
                if (user) {
                    console.log('User authenticated:', user.email);
                    console.log('User UID:', user.uid);
                    
                    // Show loading message
                    ui.loadingSpinner.classList.remove('hidden');
                    ui.loadingMessage.textContent = 'Verifying delivery access...';
                    
                    const deliveryManRef = doc(db, 'deliveryMen', user.uid);
                    console.log('Checking deliveryMen collection with UID:', user.uid);
                    
                    const deliveryManDoc = await getDoc(deliveryManRef);
                    console.log('DeliveryMan doc exists:', deliveryManDoc.exists());
                    
                    if (deliveryManDoc.exists()) {
                        console.log('Delivery man data:', deliveryManDoc.data());
                    }
                    
                    ui.loadingSpinner.classList.add('hidden');
                    
                    if (deliveryManDoc.exists()) {
                        console.log('Delivery man verified:', deliveryManDoc.data());
                        ui.loginScreen.classList.add('hidden');
                        ui.appContainer.classList.remove('hidden');
                        initializeDashboard(user, deliveryManDoc.data());
                    } else {
                        console.warn('User is not a registered delivery person');
                        console.warn('Please ensure a document exists in deliveryMen collection with UID:', user.uid);
                        await signOut(auth); 
                        ui.loginError.textContent = 'You are not registered as a delivery person. Please contact admin.';
                        ui.appContainer.classList.add('hidden');
                        ui.loginScreen.classList.remove('hidden');
                        ui.loginScreen.className = 'flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 p-4';
                    }
                } else {
                    console.log('User logged out');
                    if (state.unsubscribeOrders) state.unsubscribeOrders();
                    if (state.unsubscribeDeliveryMan) state.unsubscribeDeliveryMan();
                    if (state.unsubscribeNotifications) state.unsubscribeNotifications();
                    if (state.liveTimerInterval) clearInterval(state.liveTimerInterval);
                    
                    ui.appContainer.classList.add('hidden');
                    ui.loginScreen.classList.remove('hidden');
                    ui.loginScreen.className = 'flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 p-4';

                    const loginErrorMsg = localStorage.getItem('loginError');
                    if (loginErrorMsg) {
                        ui.loginError.textContent = loginErrorMsg;
                        localStorage.removeItem('loginError');
                    }
                }
            } catch(error) {
                console.error("Authentication check failed:", error);
                ui.loadingSpinner.classList.add('hidden');
                
                let errorMsg = "Authentication failed. Please try again.";
                if (error.code === 'permission-denied') {
                    errorMsg = "Access denied. Please contact administrator.";
                } else if (error.message) {
                    errorMsg = `Error: ${error.message}`;
                }
                
                ui.loginError.textContent = errorMsg;
                
                if (auth.currentUser) {
                    await signOut(auth);
                }
                ui.appContainer.classList.add('hidden');
                ui.loginScreen.classList.remove('hidden');
                ui.loginScreen.className = 'flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 p-4';
            }
        });

        ui.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            ui.loginError.textContent = '';
            
            const email = e.target.email.value.trim();
            const password = e.target.password.value;
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin mx-auto"></i>';
            lucide.createIcons();
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = "Incorrect email or password.";
                
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = "No account found with this email.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Please check your internet connection.";
                }
                
                ui.loginError.textContent = errorMessage;
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
        
        ui.logoutButtonModal.addEventListener('click', async () => {
            hideModal(ui.profileModal);
            
            // Stop location tracking and set offline before logout
            if (state.isOnline) {
                state.isOnline = false;
                stopLocationTracking();
                await updateOnlineStatus(false);
            }
            
            await signOut(auth);
        });

        function initializeDashboard(user, deliveryManData) {
            console.log('üöÄ [INIT] Initializing dashboard for delivery man:', {
                uid: user.uid,
                email: user.email,
                name: deliveryManData.name
            });
            
            state.currentUserData = deliveryManData;
            ui.deliveryManName.textContent = deliveryManData.name || "Delivery Staff";
            
            // Automatically request location permission and start tracking on login
            requestLocationPermissionOnLogin();
            
            initializeDatePicker();
            listenForAssignedOrders(user.uid);
            listenForDeliveryManUpdates(user.uid);
            initializeNotifications(); // Initialize SMS notifications
            lucide.createIcons();
        }
        
        // Request location permission automatically on login
        async function requestLocationPermissionOnLogin() {
            try {
                console.log('üìç Requesting location permission...');
                
                if (!navigator.geolocation) {
                    console.error('‚ùå Geolocation not supported');
                    showToast('Your browser does not support location tracking', 'error');
                    return;
                }
                
                // Request permission
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        console.log('‚úÖ Location permission granted');
                        showToast('Location tracking enabled', 'success');
                        
                        // Start tracking
                        state.isOnline = true;
                        await updateOnlineStatus(true);
                        startLocationTracking();
                    },
                    (error) => {
                        console.error('‚ùå Location permission denied:', error);
                        let errorMsg = 'Location permission denied';
                        
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMsg = 'Please enable location permission in browser settings';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = 'Location information unavailable';
                        } else if (error.code === error.TIMEOUT) {
                            errorMsg = 'Location request timed out';
                        }
                        
                        showToast(errorMsg, 'warning');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('‚ùå Error requesting location:', error);
                showToast('Failed to request location permission', 'error');
            }
        }
        
        function initializeDatePicker() {
            flatpickr(ui.collectionDate, {
                dateFormat: "Y-m-d", // Machine-readable value
                defaultDate: "today",
                altInput: true,      // Create a separate, visible input
                altFormat: "d-m-Y",  // Format for the visible input
                onChange: function(selectedDates, dateStr, instance) {
                    calculateDailyStats(state.allOrders);
                    renderAllViews(state.allOrders);
                },
            });
        }


        // --- Real-time Data Listening ---
        function listenForDeliveryManUpdates(uid) {
            if (state.unsubscribeDeliveryMan) state.unsubscribeDeliveryMan();
            
            const deliveryManRef = doc(db, 'deliveryMen', uid);
            state.unsubscribeDeliveryMan = onSnapshot(deliveryManRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.currentUserData = docSnap.data();
                    ui.deliveryManName.textContent = state.currentUserData.name || "Delivery Staff";
                    
                    if (!ui.profileModal.classList.contains('modal-hidden')) {
                        showProfileModal();
                    }
                } else {
                    console.error("Delivery man document not found. Signing out.");
                    showToast("Your account data is missing.", "error");
                    signOut(auth);
                }
            }, (error) => {
                console.error("Error listening for delivery man updates:", error);
                showToast("Could not sync profile data.", "error");
            });
        }
        
        function listenForAssignedOrders(uid) {
            console.log('üîç [DEBUG] Listening for orders assigned to delivery man:', uid);
            const ordersQuery = query(collection(db, 'orders'), where("assignedDeliveryManId", "==", uid));
            if (state.unsubscribeOrders) state.unsubscribeOrders();

            state.unsubscribeOrders = onSnapshot(ordersQuery, (snapshot) => {
                console.log('üì¶ [DEBUG] Snapshot received:', {
                    totalDocs: snapshot.docs.length,
                    docs: snapshot.docs.map(doc => ({
                        id: doc.id,
                        assignedTo: doc.data().assignedDeliveryManId,
                        status: doc.data().status,
                        orderId: doc.data().orderId
                    }))
                });
                
                const newOrders = [];
                state.allOrders = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(order => order.status !== 'cancelled' && order.status !== 'rejected');
                
                console.log('‚úÖ [DEBUG] Filtered orders:', {
                    total: state.allOrders.length,
                    orders: state.allOrders.map(o => ({ id: o.id, status: o.status, orderId: o.orderId }))
                });
                
                if (state.isFirstLoad) {
                    state.allOrders.forEach(order => state.seenOrderIds.add(order.id));
                    state.isFirstLoad = false;
                } else {
                    state.allOrders.forEach(order => {
                        if (!state.seenOrderIds.has(order.id)) {
                            newOrders.push(order);
                            state.seenOrderIds.add(order.id);
                        }
                    });
                }
                
                renderAllViews(state.allOrders);
                calculateDailyStats(state.allOrders);

                if (newOrders.length > 0) {
                    processNewOrderQueue(newOrders);
                }
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                showToast("Cannot load orders. Check Firestore rules.", "error");
            });
        }
        
        // --- UI Rendering ---
        function renderAllViews(orders) {
            const pendingOrders = orders
                .filter(o => o.status !== 'delivered')
                .sort((a, b) => {
                    const statusOrder = { 'out-for-delivery': 1, 'processing': 2 };
                    const aStatus = statusOrder[a.status] || 3;
                    const bStatus = statusOrder[b.status] || 3;
                    if (aStatus !== bStatus) return aStatus - bStatus;
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB - dateA;
                });

            const selectedDateStr = ui.collectionDate.value;
            const [year, month, day] = selectedDateStr.split('-').map(Number);
            
            const deliveredOrders = orders
                .filter(o => {
                    if (o.status === 'delivered' && o.deliveredAt) {
                         const deliveredDate = o.deliveredAt.toDate();
                         return deliveredDate.getFullYear() === year &&
                                (deliveredDate.getMonth() + 1) === month &&
                                deliveredDate.getDate() === day;
                    }
                    return false;
                })
                .sort((a, b) => (b.deliveredAt?.toMillis() || 0) - (a.deliveredAt?.toMillis() || 0));

            // Render Current Orders
            ui.orderList.innerHTML = '';
            if (pendingOrders.length === 0) {
                 ui.orderList.innerHTML = '<div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md"><p class="text-gray-500 dark:text-gray-400">No pending orders.</p></div>';
            } else {
                pendingOrders.forEach((order) => {
                    ui.orderList.insertAdjacentHTML('beforeend', createOrderCard(order, '-'));
                });
            }

            // Render History
            ui.historyList.innerHTML = '';
            if (deliveredOrders.length === 0) {
                 ui.historyList.innerHTML = `<div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md"><p class="text-gray-500 dark:text-gray-400">No deliveries found for ${new Date(year, month - 1, day).toLocaleDateString('en-US',{month:'long', day:'numeric', year:'numeric'})}.</p></div>`;
            } else {
                 deliveredOrders.forEach((order, index) => {
                    ui.historyList.insertAdjacentHTML('beforeend', createHistoryCard(order, index + 1));
                });
            }

            lucide.createIcons();
            startLiveTimers();
        }

        function createOrderCard(order, serialNumber) {
            const itemsHtml = order.items?.map(item => `<li class="truncate">${item.name} (x${item.quantity})</li>`).join('') || '';
            const { color, text, bg } = getStatusInfo(order.status);
            const isDelivered = order.status === 'delivered';
            
            // Safe handling of createdAt - support multiple formats
            let createdAtFormatted = 'N/A';
            try {
                if (order.createdAt) {
                    if (typeof order.createdAt.toDate === 'function') {
                        // Firestore Timestamp
                        createdAtFormatted = formatDateTime(order.createdAt.toDate());
                    } else if (order.createdAt instanceof Date) {
                        // Already a Date object
                        createdAtFormatted = formatDateTime(order.createdAt);
                    } else if (typeof order.createdAt === 'string') {
                        // String date
                        createdAtFormatted = formatDateTime(new Date(order.createdAt));
                    } else if (order.createdAt._seconds) {
                        // Firestore Timestamp as plain object
                        createdAtFormatted = formatDateTime(new Date(order.createdAt._seconds * 1000));
                    }
                }
            } catch (err) {
                console.warn('Error formatting createdAt for order', order.id, err);
                createdAtFormatted = 'N/A';
            }

            let timeDetailsHtml = '';
            
            // Helper function to safely convert timestamp
            const safeFormatTime = (timestamp) => {
                try {
                    if (!timestamp) return 'N/A';
                    if (typeof timestamp.toDate === 'function') return formatTime(timestamp.toDate());
                    if (timestamp instanceof Date) return formatTime(timestamp);
                    if (typeof timestamp === 'string') return formatTime(new Date(timestamp));
                    if (timestamp._seconds) return formatTime(new Date(timestamp._seconds * 1000));
                    return 'N/A';
                } catch (err) {
                    console.warn('Error formatting timestamp:', err);
                    return 'N/A';
                }
            };
            
            if (order.acceptedAt) {
                 timeDetailsHtml += `<div class="flex items-start gap-2"> <i data-lucide="play-circle" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Accepted at</p> <p class="text-xs">${safeFormatTime(order.acceptedAt)}</p> </div> </div>`;
            }

            if (order.status === 'out-for-delivery' && order.outForDeliveryAt) {
                timeDetailsHtml += `<div class="flex items-start gap-2"> <i data-lucide="timer" class="w-4 h-4 text-orange-500 mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Time Elapsed</p> <p id="timer-${order.id}" class="font-mono text-xs">...</p> </div> </div>`;
            }
            
            if (order.deliveredAt) {
                 timeDetailsHtml += `<div class="flex items-start gap-2"> <i data-lucide="flag" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Delivered at</p> <p class="text-xs">${safeFormatTime(order.deliveredAt)}</p> </div> </div>`;
            }

            if (typeof order.totalDeliveryDurationMinutes === 'number') {
                 timeDetailsHtml += `<div class="flex items-start gap-2"> <i data-lucide="award" class="w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Total Time Taken</p> <p class="text-xs">${order.totalDeliveryDurationMinutes} minutes</p> </div> </div>`;
            }
            
            const selectableOptions = ['out-for-delivery', 'delivered'];
            let allOptions = [...selectableOptions];
            if (!allOptions.includes(order.status)) {
                allOptions.unshift(order.status);
            }

            const statusDropdown = isDelivered 
                ? `<p class="font-semibold text-green-600 dark:text-green-400 flex items-center gap-1.5 text-xs sm:text-sm whitespace-nowrap"><i data-lucide="check-circle-2" class="w-4 h-4"></i><span>${text}</span></p>`
                : `<div class="relative w-full">
                    <button type="button" class="status-button w-full text-xs sm:text-sm border rounded-lg px-2 py-1.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:outline-none cursor-pointer flex items-center justify-between gap-2" data-id="${order.id}">
                        <span class="flex-1 text-left">${text}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 flex-shrink-0 transition-transform"></i>
                    </button>
                    <div class="status-dropdown-menu hidden absolute top-full left-0 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 overflow-hidden" data-id="${order.id}">
                        ${selectableOptions.map(s => {
                            const displayName = s.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const isSelected = s === order.status;
                            return `<button type="button" class="status-option w-full text-left px-3 py-2 text-xs sm:text-sm hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-white transition-colors ${isSelected ? 'bg-blue-50 dark:bg-blue-900/30 font-semibold' : ''}" data-status="${s}" data-order-id="${order.id}">
                                ${isSelected ? '<i data-lucide="check" class="w-3 h-3 inline mr-1"></i>' : ''}${displayName}
                            </button>`;
                        }).join('')}
                    </div>
                </div>`;


            
            let paymentHtml = '';
            if (order.paymentMethod && order.paymentMethod.toLowerCase() === 'cash on delivery') {
                const amount = order.totalAmount || order.amountDetails?.total || 0;
                const paymentLabel = isDelivered ? 'Payment Collected' : 'Payment to Collect';
                const textColor = isDelivered ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                const iconColor = isDelivered ? 'text-green-500' : 'text-red-500';
                const icon = isDelivered ? 'check-circle-2' : 'wallet';
                paymentHtml = `<div class="flex items-start gap-2"> <i data-lucide="${icon}" class="w-4 h-4 ${iconColor} mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">${paymentLabel}</p> <p class="font-bold text-base ${textColor}">‡ß≥${amount}</p> </div> </div>`;
            }

            return `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-4 border-l-4 ${color} ${bg}">
                <div class="mb-3">
                     <div class="flex items-center gap-2 mb-2">
                        <span class="flex items-center justify-center w-7 h-7 ${isDelivered ? 'bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-300 border-2 border-green-300 dark:border-green-700' : 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 border-2 border-blue-300 dark:border-blue-700'} font-bold rounded-full text-xs flex-shrink-0">${serialNumber}</span>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-base text-gray-800 dark:text-white truncate">Order #${order.orderId || order.id.slice(-8).toUpperCase()}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-0.5">
                                <i data-lucide="calendar-clock" class="w-3 h-3"></i>
                                <span>${createdAtFormatted}</span>
                            </p>
                        </div>
                     </div>
                     <!-- Status Dropdown Below Order Info -->
                     <div class="flex items-center gap-2 mt-2">
                        <span class="text-xs font-medium text-gray-600 dark:text-gray-400 flex-shrink-0 ml-9">Status:</span>
                        <div class="flex-1 max-w-[200px]">${statusDropdown}</div>
                     </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-3 gap-y-3 text-sm text-gray-700 dark:text-gray-300">
                    <div class="flex items-start gap-2"> <i data-lucide="user-round" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div class="min-w-0 flex-1"> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Customer</p> <p class="truncate">${order.userName || 'N/A'}</p> <div class="flex items-center gap-2 mt-1"> <p class="text-gray-600 dark:text-gray-400 text-xs">${order.deliveryAddress?.phone || 'N/A'}</p> ${order.deliveryAddress?.phone ? `<a href="tel:${order.deliveryAddress.phone}" class="flex items-center justify-center text-green-600 hover:text-green-700 h-6 w-6 rounded-full bg-green-100 hover:bg-green-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-green-400 transition-colors duration-200 transform active:scale-90" title="Call Customer"> <i data-lucide="phone" class="w-3.5 h-3.5"></i> <span class="sr-only">Call Customer</span> </a>` : ''} </div> </div> </div>
                    <div class="flex items-start gap-2"> <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div class="min-w-0 flex-1"> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Address</p> <p class="break-words text-xs leading-relaxed">${order.deliveryAddress?.address || 'N/A'}${order.deliveryAddress?.district ? ', ' + order.deliveryAddress.district : ''}${order.deliveryAddress?.thana ? ', ' + order.deliveryAddress.thana : ''}</p> ${order.deliveryAddress?.address ? `<a href="#" onclick="showMapWithRoute('${order.id}', '${order.deliveryAddress?.address || ''}', '${order.deliveryAddress?.district || ''}'); return false;" class="text-blue-500 hover:underline text-xs flex items-center gap-1 mt-1">View on Map <i data-lucide="external-link" class="w-3 h-3"></i></a>` : ''} </div> </div>
                    <div class="flex items-start gap-2"> <i data-lucide="shopping-basket" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div class="min-w-0 flex-1"> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Items</p> <ul class="list-disc list-inside space-y-0.5 mt-1 text-gray-600 dark:text-gray-400 text-xs">${itemsHtml}</ul> </div> </div>
                    ${paymentHtml}
                    ${timeDetailsHtml}
                </div>
            </div>`;
        }
        
        function createHistoryCard(order, serialNumber) {
            const itemsHtml = order.items?.map(item => `<li class="truncate">${item.name} (x${item.quantity})</li>`).join('') || '';
            
            // Safe timestamp handling
            const safeFormatTime = (timestamp) => {
                try {
                    if (!timestamp) return 'N/A';
                    if (typeof timestamp.toDate === 'function') return formatTime(timestamp.toDate());
                    if (timestamp instanceof Date) return formatTime(timestamp);
                    if (typeof timestamp === 'string') return formatTime(new Date(timestamp));
                    if (timestamp._seconds) return formatTime(new Date(timestamp._seconds * 1000));
                    return 'N/A';
                } catch (err) {
                    return 'N/A';
                }
            };

            return `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-4 border-l-4 border-green-500">
                <div class="flex justify-between items-start gap-2 mb-3">
                     <div class="flex-grow min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="flex items-center justify-center w-7 h-7 bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-300 font-bold rounded-full text-xs border-2 border-green-300 dark:border-green-700">
                                ${serialNumber}
                            </span>
                            <p class="font-bold text-base text-gray-800 dark:text-white truncate">Order #${order.orderId || order.id?.slice(0, 6).toUpperCase() || 'N/A'}</p>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 ml-9 flex items-center gap-1">
                           <i data-lucide="calendar-check" class="w-3 h-3"></i>
                           <span>Delivered at ${safeFormatTime(order.deliveredAt)}</span>
                        </p>
                     </div>
                     <span class="text-green-600 dark:text-green-400 flex-shrink-0">
                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                     </span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-3 gap-y-3 text-sm text-gray-700 dark:text-gray-300">
                    <div class="flex items-start gap-2"> <i data-lucide="user-round" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div class="min-w-0 flex-1"> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Customer</p> <p class="truncate">${order.userName || 'N/A'}</p></div> </div>
                    <div class="flex items-start gap-2"> <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div class="min-w-0 flex-1"> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Address</p> <p class="break-words text-xs leading-relaxed">${order.deliveryAddress?.address || 'N/A'}${order.deliveryAddress?.district ? ', ' + order.deliveryAddress.district : ''}${order.deliveryAddress?.thana ? ', ' + order.deliveryAddress.thana : ''}</p> ${order.deliveryAddress?.address ? `<a href="#" onclick="showMapWithRoute('${order.id}', '${order.deliveryAddress?.address || ''}', '${order.deliveryAddress?.district || ''}'); return false;" class="text-blue-500 hover:underline text-xs flex items-center gap-1 mt-1">View on Map <i data-lucide="external-link" class="w-3 h-3"></i></a>` : ''} </div> </div>
                    <div class="flex items-start gap-2"> <i data-lucide="shopping-basket" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div class="min-w-0 flex-1"> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Items</p> <ul class="list-disc list-inside space-y-0.5 mt-1 text-gray-600 dark:text-gray-400 text-xs">${itemsHtml}</ul> </div> </div>
                    ${ typeof order.totalDeliveryDurationMinutes === 'number' ? `
                    <div class="flex items-start gap-2"> <i data-lucide="timer" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">Time Taken</p> <p class="text-xs">${order.totalDeliveryDurationMinutes} minutes</p> </div> </div>
                    ` : ''}
                    ${ order.paymentMethod?.toLowerCase() === 'cash on delivery' ? `
                    <div class="flex items-start gap-2"> <i data-lucide="wallet" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i> <div> <p class="font-semibold text-gray-800 dark:text-gray-200 text-xs">COD Collected</p> <p class="font-bold text-base text-green-600 dark:text-green-400">‡ß≥${order.totalAmount || 0}</p> </div> </div>
                    ` : ''}
                </div>
            </div>`;
        }

        // --- Business Logic ---
        function calculateDailyStats(orders) {
            const selectedDateStr = ui.collectionDate.value;
            if (!selectedDateStr) {
                ui.totalCollection.textContent = '‡ß≥0';
                ui.totalDeliveries.textContent = '0';
                return;
            }
            
            const startOfDay = new Date(selectedDateStr + 'T00:00:00');
            const endOfDay = new Date(startOfDay);
            endOfDay.setDate(startOfDay.getDate() + 1);
            
            let totalCollection = 0;
            let totalDeliveries = 0;

            orders.forEach(order => {
                if (order.deliveredAt && order.status === 'delivered') {
                    const deliveredDate = order.deliveredAt.toDate();
                    if (deliveredDate >= startOfDay && deliveredDate < endOfDay) {
                        totalDeliveries++;
                        if (order.paymentMethod?.toLowerCase() === 'cash on delivery') {
                            totalCollection += (order.totalAmount || 0);
                        }
                    }
                }
            });

            ui.totalCollection.textContent = `‡ß≥${totalCollection.toFixed(0)}`;
            ui.totalDeliveries.textContent = totalDeliveries;
        }

        function startLiveTimers() {
            if (state.liveTimerInterval) clearInterval(state.liveTimerInterval);
            
            state.liveTimerInterval = setInterval(() => {
                state.allOrders.forEach(order => {
                    if (order.status === 'out-for-delivery' && order.outForDeliveryAt) {
                         const timerEl = document.getElementById(`timer-${order.id}`);
                         if (timerEl) {
                            const elapsed = new Date().getTime() - order.outForDeliveryAt.toDate().getTime();
                            const minutes = Math.floor(elapsed / 60000);
                            const seconds = Math.floor((elapsed % 60000) / 1000);
                            timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        }
                    }
                });
            }, 1000);
        }

        // --- Event Listeners & Actions ---
        ui.currentOrdersTab.addEventListener('click', async () => {
            // Stop camera if running
            await stopCameraScanner();
            
            ui.currentOrdersTab.classList.add('tab-active');
            ui.currentOrdersTab.classList.remove('text-gray-600', 'dark:text-gray-300');
            ui.scanQrTab.classList.remove('tab-active');
            ui.scanQrTab.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.historyTab.classList.remove('tab-active');
            ui.historyTab.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.orderList.classList.remove('hidden');
            ui.qrScannerSection.classList.add('hidden');
            ui.historyList.classList.add('hidden');
            ui.viewTitle.textContent = "Current Orders";
        });

        ui.scanQrTab.addEventListener('click', async () => {
            ui.scanQrTab.classList.add('tab-active');
            ui.scanQrTab.classList.remove('text-gray-600', 'dark:text-gray-300');
            ui.currentOrdersTab.classList.remove('tab-active');
            ui.currentOrdersTab.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.historyTab.classList.remove('tab-active');
            ui.historyTab.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.qrScannerSection.classList.remove('hidden');
            ui.orderList.classList.add('hidden');
            ui.historyList.classList.add('hidden');
            ui.viewTitle.textContent = "Scan QR Code";
            
            // Initialize camera scanner view (default)
            ui.cameraTabBtn?.click();
        });

        ui.historyTab.addEventListener('click', async () => {
            // Stop camera if running
            await stopCameraScanner();
            
            ui.historyTab.classList.add('tab-active');
            ui.historyTab.classList.remove('text-gray-600', 'dark:text-gray-300');
            ui.currentOrdersTab.classList.remove('tab-active');
            ui.currentOrdersTab.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.scanQrTab.classList.remove('tab-active');
            ui.scanQrTab.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.historyList.classList.remove('hidden');
            ui.qrScannerSection.classList.add('hidden');
            ui.orderList.classList.add('hidden');
            ui.viewTitle.textContent = "Delivery History";
        });

        ui.refreshButton.addEventListener('click', () => {
            const icon = ui.refreshButton.querySelector('svg');
            if (icon) {
                icon.classList.add('animate-spin');
            }
            ui.refreshButton.disabled = true;

            // Reset to default view (Current Orders)
            if (ui.historyList.classList.contains('hidden')) {
                 ui.currentOrdersTab.click();
            }
           
            renderAllViews(state.allOrders);
            calculateDailyStats(state.allOrders);

            setTimeout(() => {
                const currentIcon = ui.refreshButton.querySelector('svg');
                if (currentIcon) {
                    currentIcon.classList.remove('animate-spin');
                }
                ui.refreshButton.disabled = false;
                showToast("View refreshed!");
            }, 700);
        });
        
        // Status Dropdown Toggle - Button Click
        document.addEventListener('click', async (e) => {
            // Toggle dropdown menu
            if (e.target.closest('.status-button')) {
                const button = e.target.closest('.status-button');
                const orderId = button.dataset.id;
                const menu = document.querySelector(`.status-dropdown-menu[data-id="${orderId}"]`);
                const chevron = button.querySelector('[data-lucide="chevron-down"]');
                
                // Close all other dropdowns
                document.querySelectorAll('.status-dropdown-menu').forEach(m => {
                    if (m !== menu) {
                        m.classList.add('hidden');
                        const otherButton = document.querySelector(`.status-button[data-id="${m.dataset.id}"]`);
                        if (otherButton) {
                            const otherChevron = otherButton.querySelector('[data-lucide="chevron-down"]');
                            if (otherChevron) otherChevron.style.transform = '';
                        }
                    }
                });
                
                // Toggle current dropdown
                menu.classList.toggle('hidden');
                if (chevron) {
                    chevron.style.transform = menu.classList.contains('hidden') ? '' : 'rotate(180deg)';
                }
                return;
            }
            
            // Handle status option click
            if (e.target.closest('.status-option')) {
                const option = e.target.closest('.status-option');
                const orderId = option.dataset.orderId;
                const newStatus = option.dataset.status;
                const previousStatus = state.allOrders.find(o => o.id === orderId)?.status || '';
                
                // Close dropdown
                const menu = option.closest('.status-dropdown-menu');
                menu.classList.add('hidden');
                const button = document.querySelector(`.status-button[data-id="${orderId}"]`);
                const chevron = button?.querySelector('[data-lucide="chevron-down"]');
                if (chevron) chevron.style.transform = '';
                
                // If trying to change to "delivered", require QR scan and photo
                if (newStatus === 'delivered') {
                    showDeliveryConfirmationModal(orderId);
                    return;
                }
                
                // For other status changes (e.g., out-for-delivery)
                const orderRef = doc(db, 'orders', orderId);
                
                try {
                    // Check if order has assignedDeliveryManId, if not set it first
                    const orderSnap = await getDoc(orderRef);
                    const orderData = orderSnap.data();
                    
                    if (!orderData.assignedDeliveryManId && auth.currentUser) {
                        // Assign this order to current delivery man first
                        await updateDoc(orderRef, {
                            assignedDeliveryManId: auth.currentUser.uid,
                            assignedDeliveryManName: state.currentUserData?.name || 'N/A',
                            assignedDeliveryManPhone: state.currentUserData?.phone || 'N/A'
                        });
                    }
                    
                    // Now update the status
                    let updatePayload = { status: newStatus };
                    if (newStatus === 'out-for-delivery') {
                        updatePayload.outForDeliveryAt = new Date();
                    }

                    await updateDoc(orderRef, updatePayload);
                    showToast(`Order status updated to ${newStatus.replace(/-/g, ' ')}.`, 'success');
                } catch(error) {
                    console.error("Failed to update order status:", error);
                    showToast("Failed to update status.", "error");
                }
                return;
            }
            
            // Close all dropdowns when clicking outside
            if (!e.target.closest('.status-button') && !e.target.closest('.status-dropdown-menu')) {
                document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                    menu.classList.add('hidden');
                    const button = document.querySelector(`.status-button[data-id="${menu.dataset.id}"]`);
                    if (button) {
                        const chevron = button.querySelector('[data-lucide="chevron-down"]');
                        if (chevron) chevron.style.transform = '';
                    }
                });
            }
        });
        
        document.addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-change-delivery')) {
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                const previousStatus = state.allOrders.find(o => o.id === orderId)?.status || '';
                
                // If trying to change to "delivered", require QR scan and photo
                if (newStatus === 'delivered') {
                    // Reset dropdown to previous value
                    e.target.value = previousStatus;
                    
                    // Show confirmation modal for delivery with QR scan
                    showDeliveryConfirmationModal(orderId);
                    return;
                }
                
                // For other status changes (e.g., out-for-delivery)
                const orderRef = doc(db, 'orders', orderId);

                try {
                    // Check if order has assignedDeliveryManId, if not set it first
                    const orderSnap = await getDoc(orderRef);
                    const orderData = orderSnap.data();
                    
                    if (!orderData.assignedDeliveryManId && auth.currentUser) {
                        // Assign this order to current delivery man first
                        await updateDoc(orderRef, {
                            assignedDeliveryManId: auth.currentUser.uid,
                            assignedDeliveryManName: state.currentUserData?.name || 'N/A',
                            assignedDeliveryManPhone: state.currentUserData?.phone || 'N/A'
                        });
                    }
                    
                    // Now update the status
                    let updatePayload = { status: newStatus };
                    if (newStatus === 'out-for-delivery') {
                        updatePayload.outForDeliveryAt = new Date();
                    }

                    await updateDoc(orderRef, updatePayload);
                    showToast(`Order status updated to ${newStatus}.`);
                } catch(error) {
                    console.error("Failed to update order status:", error);
                    showToast("Could not update status.", "error");
                    e.target.value = previousStatus;
                }
            }
        });

        // --- New Order Pop-up Logic ---
        function processNewOrderQueue(newOrders) {
            state.newOrderQueue.push(...newOrders);
            if (ui.newOrderModal.classList.contains('modal-hidden')) {
                 showNextOrderInQueue();
            }
        }

        function showNextOrderInQueue() {
            if (state.newOrderQueue.length === 0 || !ui.newOrderModal.classList.contains('modal-hidden')) return;
            const order = state.newOrderQueue.shift();
            
            ui.acceptOrderBtn.dataset.orderId = order.id;

            ui.newOrderDetails.innerHTML = `
                <p><strong>Order ID:</strong> #${order.orderId || order.id.slice(-8).toUpperCase()}</p>
                <p><strong>Customer:</strong> ${order.userName || 'N/A'}</p>
                <p><strong>Phone:</strong> ${order.deliveryAddress?.phone || 'N/A'}</p>
                <p><strong>Address:</strong> ${order.deliveryAddress?.address || 'N/A'}${order.deliveryAddress?.district ? ', ' + order.deliveryAddress.district : ''}${order.deliveryAddress?.thana ? ', ' + order.deliveryAddress.thana : ''}</p>
                <p><strong>Total:</strong> ‡ß≥${order.amountDetails?.total || order.totalAmount || 0}</p>
            `;
            showModal(ui.newOrderModal);
            playNotificationSound();
        }
        
        ui.acceptOrderBtn.addEventListener('click', async (e) => {
            const orderId = e.currentTarget.dataset.orderId;
            if (!orderId || !auth.currentUser) return;

            try {
                // Set assignedDeliveryManId when accepting order
                await updateDoc(doc(db, 'orders', orderId), { 
                    acceptedAt: new Date(),
                    assignedDeliveryManId: auth.currentUser.uid,
                    assignedDeliveryManName: state.currentUserData?.name || 'N/A',
                    assignedDeliveryManPhone: state.currentUserData?.phone || 'N/A'
                });
                showToast("Order accepted!", "success");
            } catch (error) {
                console.error("Failed to accept order:", error);
                showToast("Could not accept order.", "error");
            }
            
            hideModal(ui.newOrderModal);
            setTimeout(showNextOrderInQueue, 300); 
        });

        // --- Profile Modal Logic ---
        function showProfileModal() {
            if (!auth.currentUser || !state.currentUserData) return;

            const deliveredOrders = state.allOrders.filter(o => o.status === 'delivered');
            const totalDelivered = deliveredOrders.length;
            const totalCod = deliveredOrders.reduce((sum, order) => (order.paymentMethod?.toLowerCase() === 'cash on delivery') ? sum + (order.totalAmount || 0) : sum, 0);
            
            ui.profileName.textContent = state.currentUserData.name || 'Delivery Staff';
            ui.profileEmail.textContent = auth.currentUser.email;
            ui.profilePhone.textContent = state.currentUserData.phone || 'N/A';
            ui.profileVehicle.textContent = state.currentUserData.vehicle || 'N/A';
            
            if (state.currentUserData.accountStatus === 'active') {
                ui.profileStatus.textContent = 'Active';
                ui.profileStatus.className = 'px-2 py-1 text-xs font-bold text-green-800 bg-green-200 dark:text-green-200 dark:bg-green-800 rounded-full';
            } else {
                ui.profileStatus.textContent = 'Inactive';
                ui.profileStatus.className = 'px-2 py-1 text-xs font-bold text-red-800 bg-red-200 dark:text-red-200 dark:bg-red-800 rounded-full';
            }

            ui.profileTotalOrders.textContent = totalDelivered;
            ui.profileTotalCod.textContent = `‡ß≥${totalCod.toFixed(0)}`;

            showModal(ui.profileModal);
        }

        ui.profileButton.addEventListener('click', showProfileModal);
        ui.closeProfileModalBtn.addEventListener('click', () => hideModal(ui.profileModal));
        ui.profileModal.querySelector('.modal-backdrop').addEventListener('click', () => hideModal(ui.profileModal));


        // --- Utility Functions (Sound, Modals, Toast) ---
        function playNotificationSound() {
            if (!state.audioContext) {
                try {
                  state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) {
                  console.warn("Web Audio API is not supported in this browser.");
                  return;
                }
            }
            if (state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }
            const oscillator = state.audioContext.createOscillator();
            const gainNode = state.audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(state.audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, state.audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, state.audioContext.currentTime);
            oscillator.start();
            oscillator.stop(state.audioContext.currentTime + 0.2);
        }

        function showModal(modal) {
            modal.classList.remove('modal-hidden');
            lucide.createIcons();
        }

        function hideModal(modal) {
            modal.classList.add('modal-hidden');
        }

        function formatDateTime(date) {
            if (!date || !(date instanceof Date)) return 'N/A';
            return date.toLocaleString('en-US', {
                month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            });
        }
        
        function formatTime(date) {
            if (!date || !(date instanceof Date)) return '';
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        /**
         * Show map with route from delivery man to customer location
         */
        async function showMapWithRoute(orderId, customerAddress, customerDistrict) {
            try {
                console.log('üó∫Ô∏è Map requested for:', { orderId, customerAddress, customerDistrict });
                
                const destination = encodeURIComponent(`${customerAddress}, ${customerDistrict}, Bangladesh`);
                
                // Check if we have current location for directions
                if (state.lastLocation) {
                    // We have location - show route from current location to customer
                    const deliveryLat = state.lastLocation.latitude;
                    const deliveryLng = state.lastLocation.longitude;
                    const origin = `${deliveryLat},${deliveryLng}`;
                    
                    console.log('üó∫Ô∏è Opening map with route from:', origin, 'to:', destination);
                    
                    // Open Google Maps with directions
                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
                    window.open(mapsUrl, '_blank');
                    showToast('Opening map with route...', 'info');
                } else {
                    console.log('üó∫Ô∏è Opening customer location only (no current location)');
                    
                    // No location - just show customer location on map
                    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${destination}`;
                    window.open(mapsUrl, '_blank');
                    showToast('Opening customer location...', 'info');
                }
            } catch (error) {
                console.error('‚ùå Error showing map:', error);
                showToast('Failed to open map', 'error');
            }
        }
        
        // Make showMapWithRoute globally accessible for onclick handlers
        window.showMapWithRoute = showMapWithRoute;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            const colorClasses = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500 text-black',
                info: 'bg-blue-500'
            };
            toast.className = `fixed bottom-5 right-5 text-white py-2.5 px-5 rounded-lg shadow-lg transition-all duration-300 ${colorClasses[type] || 'bg-green-500'} z-50`;
            toast.classList.remove('toast-enter', 'toast-exit-active');
            toast.classList.add('toast-enter-active');
            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
            }, 4000);
        }
        
        // --- QR Code Scanner Functions ---
        // Initialize QR Code Scanner
        function initQRScanner() {
            if (!state.html5QrCode) {
                state.html5QrCode = new Html5Qrcode("qr-reader");
            }
        }

        // Start Camera Scanner
        async function startCameraScanner() {
            try {
                initQRScanner();
                
                ui.startScanBtn.disabled = true;
                ui.startScanBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Starting...';
                lucide.createIcons();

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                };

                await state.html5QrCode.start(
                    { facingMode: "environment" }, // Use back camera
                    config,
                    (decodedText, decodedResult) => {
                        // QR Code detected
                        console.log('QR Code detected:', decodedText);
                        
                        // Stop scanner and process
                        stopCameraScanner();
                        confirmDeliveryByQR(decodedText);
                    },
                    (errorMessage) => {
                        // Scanning errors (can be ignored - happens when no QR code in frame)
                    }
                );

                state.isScannerRunning = true;
                ui.startScanBtn.classList.add('hidden');
                ui.stopScanBtn.classList.remove('hidden');
                ui.stopScanBtn.className = 'px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition-colors flex items-center gap-2';
                showToast('Camera started. Point at QR code.', 'success');

            } catch (err) {
                console.error('Error starting camera:', err);
                let errorMsg = 'Failed to start camera. ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMsg += 'Please allow camera access.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'No camera found on device.';
                } else if (err.name === 'NotReadableError') {
                    errorMsg += 'Camera is already in use.';
                } else {
                    errorMsg += err.message || 'Unknown error.';
                }
                
                showToast(errorMsg, 'error');
                ui.startScanBtn.disabled = false;
                ui.startScanBtn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i> Start Camera';
                lucide.createIcons();
            }
        }

        // Stop Camera Scanner
        async function stopCameraScanner() {
            if (state.html5QrCode && state.isScannerRunning) {
                try {
                    await state.html5QrCode.stop();
                    state.isScannerRunning = false;
                    ui.stopScanBtn.classList.add('hidden');
                    ui.startScanBtn.classList.remove('hidden');
                    ui.startScanBtn.disabled = false;
                    ui.startScanBtn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i> Start Camera';
                    lucide.createIcons();
                } catch (err) {
                    console.error('Error stopping camera:', err);
                }
            }
        }

        // Tab Switching for Scanner
        ui.cameraTabBtn?.addEventListener('click', () => {
            ui.cameraTabBtn.classList.add('bg-blue-600', 'text-white');
            ui.cameraTabBtn.classList.remove('text-gray-600', 'dark:text-gray-300');
            ui.manualTabBtn.classList.remove('bg-blue-600', 'text-white');
            ui.manualTabBtn.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.cameraScannerView.classList.remove('hidden');
            ui.manualEntryView.classList.add('hidden');
            ui.qrScanResult.classList.add('hidden');
        });

        ui.manualTabBtn?.addEventListener('click', async () => {
            // Stop camera if running
            await stopCameraScanner();
            
            ui.manualTabBtn.classList.add('bg-blue-600', 'text-white');
            ui.manualTabBtn.classList.remove('text-gray-600', 'dark:text-gray-300');
            ui.cameraTabBtn.classList.remove('bg-blue-600', 'text-white');
            ui.cameraTabBtn.classList.add('text-gray-600', 'dark:text-gray-300');
            ui.manualEntryView.classList.remove('hidden');
            ui.cameraScannerView.classList.add('hidden');
            ui.qrScanResult.classList.add('hidden');
            
            // Focus input
            setTimeout(() => ui.qrScanInput?.focus(), 100);
        });

        // Start/Stop Scanner Buttons
        ui.startScanBtn?.addEventListener('click', startCameraScanner);
        ui.stopScanBtn?.addEventListener('click', stopCameraScanner);

        const confirmDeliveryByQR = async (orderId) => {
            const resultDiv = ui.qrScanResult;
            const scanInput = ui.qrScanInput;
            
            if (!orderId || !orderId.trim()) {
                resultDiv.className = 'mt-4 p-4 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 rounded-lg';
                resultDiv.textContent = 'Please enter or scan a valid Order ID!';
                resultDiv.classList.remove('hidden');
                return;
            }

            try {
                resultDiv.className = 'mt-4 p-4 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-lg';
                resultDiv.textContent = 'Processing...';
                resultDiv.classList.remove('hidden');

                // Fetch order from database
                const orderRef = doc(db, 'orders', orderId);
                const orderSnap = await getDoc(orderRef);

                if (!orderSnap.exists()) {
                    resultDiv.className = 'mt-4 p-4 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 rounded-lg';
                    resultDiv.innerHTML = `<strong>Error:</strong> Order ID <code class="font-mono">${orderId}</code> not found!`;
                    return;
                }

                const orderData = orderSnap.data();
                const currentStatus = orderData.status || 'pending';

                // Check if order is already delivered
                if (currentStatus === 'delivered') {
                    resultDiv.className = 'mt-4 p-4 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 rounded-lg';
                    resultDiv.innerHTML = `<strong>Already Delivered:</strong> Order <code class="font-mono">#${orderData.orderId || orderId.substring(0, 6)}</code> was delivered.`;
                    return;
                }

                // Check if order is assigned to this delivery man, if not assign it
                if (auth.currentUser) {
                    if (orderData.assignedDeliveryManId && orderData.assignedDeliveryManId !== auth.currentUser.uid) {
                        resultDiv.className = 'mt-4 p-4 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 rounded-lg';
                        resultDiv.innerHTML = `<strong>Not Assigned:</strong> This order is assigned to another delivery person!`;
                        return;
                    }
                    
                    // If not assigned, assign to current delivery man
                    if (!orderData.assignedDeliveryManId) {
                        try {
                            await updateDoc(orderRef, {
                                assignedDeliveryManId: auth.currentUser.uid,
                                assignedDeliveryManName: state.currentUserData?.name || 'N/A',
                                assignedDeliveryManPhone: state.currentUserData?.phone || 'N/A'
                            });
                        } catch (assignError) {
                            console.error('Error assigning order:', assignError);
                            resultDiv.className = 'mt-4 p-4 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 rounded-lg';
                            resultDiv.innerHTML = `<strong>Error:</strong> Could not assign order. ${assignError.message}`;
                            return;
                        }
                    }
                }

                // Check if order is in shipped or out-for-delivery status
                if (currentStatus !== 'shipped' && currentStatus !== 'out-for-delivery') {
                    resultDiv.className = 'mt-4 p-4 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 rounded-lg';
                    resultDiv.innerHTML = `<strong>Invalid Status:</strong> Order must be "Shipped" or "Out for Delivery". Current: <strong>${currentStatus}</strong>`;
                    return;
                }

                // Show image capture prompt
                resultDiv.className = 'mt-4 p-4 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-lg';
                resultDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <i data-lucide="camera" class="w-6 h-6 mt-0.5"></i>
                        <div class="flex-1">
                            <strong class="text-lg">Capture Delivery Photo</strong>
                            <p class="mt-1">Please take a photo as proof of delivery for Order <code class="font-mono font-semibold">#${orderData.orderId || orderId.substring(0, 6)}</code></p>
                            <div class="mt-3 space-y-2">
                                <input type="file" id="delivery-photo-input-qr" accept="image/*" capture="environment" 
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/50 dark:file:text-blue-200">
                                <div class="flex gap-2">
                                    <button id="upload-delivery-photo-btn-qr" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                                        <i data-lucide="upload" class="w-4 h-4"></i>
                                        Upload Photo
                                    </button>
                                    <button id="skip-delivery-photo-btn-qr" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                                        Skip Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();

                // Handle photo upload
                const uploadBtn = document.getElementById('upload-delivery-photo-btn-qr');
                const skipBtn = document.getElementById('skip-delivery-photo-btn-qr');
                const photoInput = document.getElementById('delivery-photo-input-qr');

                const completeDelivery = async (photoURL = null) => {
                    try {
                        // Update order status to delivered (only allowed fields)
                        const updateData = {
                            status: 'delivered',
                            deliveredAt: serverTimestamp()
                        };
                        
                        await updateDoc(orderRef, updateData);

                        // Store additional delivery details in a separate subcollection (optional)
                        // This avoids permission issues while keeping extra data
                        try {
                            const deliveryDetailsRef = doc(db, 'orders', orderId, 'deliveryDetails', 'confirmation');
                            await setDoc(deliveryDetailsRef, {
                                scannedByQRCode: true,
                                deliveryConfirmedAt: new Date().toISOString(),
                                deliveryPhotoURL: photoURL || null,
                                deliveredBy: auth.currentUser?.uid || null,
                                deliveredByName: state.currentUserData?.name || 'N/A'
                            });
                        } catch (subError) {
                            console.log('Note: Could not store delivery details subcollection:', subError.message);
                        }

                        // Success message
                        resultDiv.className = 'mt-4 p-4 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded-lg';
                        resultDiv.innerHTML = `
                            <div class="flex items-start gap-3">
                                <i data-lucide="check-circle" class="w-6 h-6 mt-0.5"></i>
                                <div>
                                    <strong class="text-lg">Delivery Confirmed!</strong>
                                    <p class="mt-1">Order <code class="font-mono font-semibold">#${orderData.orderId || orderId.substring(0, 6)}</code> has been successfully delivered.</p>
                                    <p class="mt-1 text-sm">Customer: <strong>${orderData.userName || 'N/A'}</strong></p>
                                    <p class="text-sm">Total Amount: <strong>‡ß≥${(orderData.totalAmount || 0).toFixed(2)}</strong></p>
                                    <p class="text-sm">Delivered at: <strong>${new Date().toLocaleString()}</strong></p>
                                    ${photoURL ? '<p class="text-sm text-green-700 dark:text-green-300"><i data-lucide="check" class="w-4 h-4 inline"></i> Delivery photo uploaded</p>' : ''}
                                </div>
                            </div>
                        `;
                        lucide.createIcons();

                        // Clear input
                        if (scanInput) scanInput.value = '';

                        // Show toast
                        showToast(`Order #${orderData.orderId || orderId.substring(0, 6)} delivered successfully!`, 'success');

                    } catch (error) {
                        console.error('Error completing delivery:', error);
                        resultDiv.className = 'mt-4 p-4 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 rounded-lg';
                        resultDiv.innerHTML = `<strong>Error:</strong> Failed to complete delivery. ${error.message}`;
                    }
                };

                // Upload photo button click
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', async () => {
                        const file = photoInput?.files?.[0];
                        if (!file) {
                            showToast('Please select a photo first!', 'error');
                            return;
                        }

                        try {
                            uploadBtn.disabled = true;
                            uploadBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Uploading...';
                            lucide.createIcons();

                            // Upload to Firebase Storage
                            const storage = getStorage();
                            const timestamp = Date.now();
                            const fileName = `delivery-photos/${orderId}_${timestamp}.jpg`;
                            const storageRef = ref(storage, fileName);
                            
                            await uploadBytes(storageRef, file);
                            const photoURL = await getDownloadURL(storageRef);
                            
                            await completeDelivery(photoURL);
                        } catch (error) {
                            console.error('Error uploading photo:', error);
                            showToast('Failed to upload photo: ' + error.message, 'error');
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i data-lucide="upload" class="w-4 h-4"></i> Upload Photo';
                            lucide.createIcons();
                        }
                    });
                }

                // Skip photo button click
                if (skipBtn) {
                    skipBtn.addEventListener('click', () => {
                        completeDelivery(null);
                    });
                }

            } catch (error) {
                console.error('Error confirming delivery:', error);
                resultDiv.className = 'mt-4 p-4 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 rounded-lg';
                resultDiv.innerHTML = `<strong>Error:</strong> Failed to confirm delivery. ${error.message}`;
            }
        };

        // Setup QR scanner event listeners
        ui.confirmScanBtn?.addEventListener('click', () => {
            const orderId = ui.qrScanInput?.value.trim() || '';
            confirmDeliveryByQR(orderId);
        });

        ui.qrScanInput?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const orderId = ui.qrScanInput.value.trim();
                confirmDeliveryByQR(orderId);
            }
        });

        ui.qrScanInput?.addEventListener('focus', () => {
            if (ui.qrScanResult) ui.qrScanResult.classList.add('hidden');
        });

        // --- Delivery Confirmation Modal Functions ---
        function showDeliveryConfirmationModal(orderId) {
            state.pendingDeliveryOrderId = orderId;
            
            // Get order details
            const order = state.allOrders.find(o => o.id === orderId);
            if (!order) {
                showToast('Order not found!', 'error');
                return;
            }
            
            const orderIdDisplay = order.orderId || orderId.substring(0, 6);
            ui.confirmOrderId.textContent = `#${orderIdDisplay}`;
            
            // Reset modal to step 1
            ui.qrScanStep.classList.remove('hidden');
            ui.photoUploadStep.classList.add('hidden');
            ui.qrScanStatus.classList.add('hidden');
            
            // Show modal
            showModal(ui.deliveryConfirmModal);
        }

        function hideDeliveryConfirmationModal() {
            stopConfirmScanner();
            state.pendingDeliveryOrderId = null;
            hideModal(ui.deliveryConfirmModal);
        }

        // Start QR Scanner in Confirmation Modal
        async function startConfirmScanner() {
            try {
                if (!state.html5QrCodeConfirm) {
                    state.html5QrCodeConfirm = new Html5Qrcode("qr-reader-confirm");
                }
                
                ui.startScanConfirmBtn.disabled = true;
                ui.startScanConfirmBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Starting...';
                lucide.createIcons();

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                };

                await state.html5QrCodeConfirm.start(
                    { facingMode: "environment" },
                    config,
                    async (decodedText, decodedResult) => {
                        console.log('QR Code scanned:', decodedText);
                        
                        // Verify if scanned QR matches the order ID
                        if (decodedText === state.pendingDeliveryOrderId) {
                            // Success! Stop scanner and move to photo step
                            await stopConfirmScanner();
                            
                            ui.qrScanStatus.className = 'p-4 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded-lg flex items-center gap-2';
                            ui.qrScanStatus.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5"></i> <span>QR Code Verified!</span>';
                            ui.qrScanStatus.classList.remove('hidden');
                            lucide.createIcons();
                            
                            // Move to photo upload step
                            setTimeout(() => {
                                ui.qrScanStep.classList.add('hidden');
                                ui.photoUploadStep.classList.remove('hidden');
                            }, 1000);
                            
                        } else {
                            // Wrong QR code
                            ui.qrScanStatus.className = 'p-4 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 rounded-lg flex items-center gap-2';
                            ui.qrScanStatus.innerHTML = '<i data-lucide="x-circle" class="w-5 h-5"></i> <span>Wrong QR Code! Please scan the correct order label.</span>';
                            ui.qrScanStatus.classList.remove('hidden');
                            lucide.createIcons();
                        }
                    },
                    (errorMessage) => {
                        // Scanning errors (ignore)
                    }
                );

                state.isScannerRunningConfirm = true;
                ui.startScanConfirmBtn.classList.add('hidden');
                ui.stopScanConfirmBtn.classList.remove('hidden');
                ui.stopScanConfirmBtn.className = 'px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition-colors flex items-center gap-2';

            } catch (err) {
                console.error('Error starting confirmation scanner:', err);
                let errorMsg = 'Failed to start camera. ';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg += 'Please allow camera access.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'No camera found.';
                } else {
                    errorMsg += err.message || 'Unknown error.';
                }
                
                showToast(errorMsg, 'error');
                ui.startScanConfirmBtn.disabled = false;
                ui.startScanConfirmBtn.innerHTML = '<i data-lucide="camera" class="w-5 h-5"></i> Start QR Scanner';
                lucide.createIcons();
            }
        }

        // Stop Confirmation Scanner
        async function stopConfirmScanner() {
            if (state.html5QrCodeConfirm && state.isScannerRunningConfirm) {
                try {
                    await state.html5QrCodeConfirm.stop();
                    state.isScannerRunningConfirm = false;
                    ui.stopScanConfirmBtn.classList.add('hidden');
                    ui.startScanConfirmBtn.classList.remove('hidden');
                    ui.startScanConfirmBtn.disabled = false;
                    ui.startScanConfirmBtn.innerHTML = '<i data-lucide="camera" class="w-5 h-5"></i> Start QR Scanner';
                    lucide.createIcons();
                } catch (err) {
                    console.error('Error stopping confirmation scanner:', err);
                }
            }
        }

        // Complete Delivery with Photo
        async function completeDeliveryWithPhoto(photoURL = null) {
            if (!state.pendingDeliveryOrderId) {
                showToast('No order selected!', 'error');
                return;
            }

            try {
                const orderRef = doc(db, 'orders', state.pendingDeliveryOrderId);
                const orderSnap = await getDoc(orderRef);
                const orderData = orderSnap.data();
                
                const startTime = orderData.acceptedAt?.toDate() || orderData.createdAt?.toDate();
                const deliveredAtTime = new Date();
                
                const updatePayload = {
                    status: 'delivered',
                    deliveredAt: serverTimestamp(),
                    scannedByQRCode: true,
                    deliveryConfirmedAt: deliveredAtTime.toISOString()
                };

                if (startTime) {
                    const totalDurationInMinutes = Math.round((deliveredAtTime - startTime) / 60000);
                    updatePayload.totalDeliveryDurationMinutes = totalDurationInMinutes;
                }
                
                if (photoURL) {
                    updatePayload.deliveryPhotoURL = photoURL;
                }
                
                await updateDoc(orderRef, updatePayload);
                
                showToast('Order delivered successfully!', 'success');
                hideDeliveryConfirmationModal();
                
            } catch (error) {
                console.error('Error completing delivery:', error);
                showToast('Failed to complete delivery: ' + error.message, 'error');
            }
        }

        // Event Listeners for Confirmation Modal
        ui.closeDeliveryConfirmBtn?.addEventListener('click', hideDeliveryConfirmationModal);
        ui.deliveryConfirmModal?.querySelector('.modal-backdrop')?.addEventListener('click', hideDeliveryConfirmationModal);
        
        ui.startScanConfirmBtn?.addEventListener('click', startConfirmScanner);
        ui.stopScanConfirmBtn?.addEventListener('click', stopConfirmScanner);

        // Photo preview
        ui.deliveryPhotoConfirm?.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    ui.photoPreviewImg.src = event.target.result;
                    ui.photoPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Upload photo and complete delivery
        ui.uploadConfirmBtn?.addEventListener('click', async () => {
            const file = ui.deliveryPhotoConfirm?.files?.[0];
            
            if (!file) {
                showToast('Please select a photo first!', 'error');
                return;
            }

            try {
                ui.uploadConfirmBtn.disabled = true;
                ui.uploadConfirmBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Uploading...';
                lucide.createIcons();

                const storage = getStorage();
                const timestamp = Date.now();
                const fileName = `delivery-photos/${state.pendingDeliveryOrderId}_${timestamp}.jpg`;
                const storageRef = ref(storage, fileName);
                
                await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(storageRef);
                
                await completeDeliveryWithPhoto(photoURL);
                
            } catch (error) {
                console.error('Error uploading photo:', error);
                showToast('Failed to upload photo: ' + error.message, 'error');
                ui.uploadConfirmBtn.disabled = false;
                ui.uploadConfirmBtn.innerHTML = '<i data-lucide="upload" class="w-5 h-5"></i> Complete Delivery';
                lucide.createIcons();
            }
        });

        // Skip photo
        ui.skipPhotoConfirmBtn?.addEventListener('click', () => {
            completeDeliveryWithPhoto(null);
        });
        
        // --- Location Tracking Functions ---
        
        /**
         * Calculate distance between two coordinates using Haversine formula
         * @param {number} lat1 - Latitude of first point
         * @param {number} lon1 - Longitude of first point
         * @param {number} lat2 - Latitude of second point
         * @param {number} lon2 - Longitude of second point
         * @returns {number} Distance in meters
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        /**
         * Check if location should be updated based on movement or time
         * @param {number} newLat - New latitude
         * @param {number} newLng - New longitude
         * @returns {boolean} True if should update
         */
        function shouldUpdateLocation(newLat, newLng) {
            const now = Date.now();
            const MINIMUM_DISTANCE = 50; // 50 meters
            const MINIMUM_TIME = 30000; // 30 seconds

            // Always update if no previous location
            if (!state.lastLocation) {
                return true;
            }

            // Update if 30 seconds have passed
            if (!state.lastLocationUpdateTime || (now - state.lastLocationUpdateTime) >= MINIMUM_TIME) {
                return true;
            }

            // Update if moved more than 50 meters
            const distance = calculateDistance(
                state.lastLocation.lat,
                state.lastLocation.lng,
                newLat,
                newLng
            );

            return distance >= MINIMUM_DISTANCE;
        }

        /**
         * Update location in Firestore
         * @param {number} lat - Latitude
         * @param {number} lng - Longitude
         */
        async function updateLocationInFirestore(lat, lng) {
            if (!auth.currentUser) return;

            try {
                const deliveryManRef = doc(db, 'deliveryMen', auth.currentUser.uid);
                await updateDoc(deliveryManRef, {
                    lastLocation: new GeoPoint(lat, lng),
                    lastStatusUpdate: serverTimestamp(),
                    isOnline: state.isOnline
                });

                state.lastLocation = { lat, lng };
                state.lastLocationUpdateTime = Date.now();
                
                console.log('‚úÖ Location updated with GeoPoint:', { lat, lng, isOnline: state.isOnline });
            } catch (error) {
                console.error('‚ùå Error updating location:', error);
                showToast('Failed to update location', 'error');
            }
        }

        /**
         * Start tracking location
         */
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser', 'error');
                return;
            }

            // Stop existing watch if any
            stopLocationTracking();

            const options = {
                enableHighAccuracy: true, // Use GPS if available
                timeout: 10000, // 10 seconds
                maximumAge: 0 // Don't use cached position
            };

            state.locationWatchId = navigator.geolocation.watchPosition(
                // Success callback
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    console.log('Location received:', { lat: latitude, lng: longitude, accuracy: position.coords.accuracy });

                    // Check if we should update Firestore
                    if (shouldUpdateLocation(latitude, longitude)) {
                        await updateLocationInFirestore(latitude, longitude);
                    }
                },
                // Error callback
                (error) => {
                    console.error('Location error:', error);
                    let errorMsg = 'Location error: ';
                    
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Permission denied. Please enable location access.';
                            // Turn off online status
                            ui.onlineToggle.checked = false;
                            state.isOnline = false;
                            updateOnlineStatusUI();
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Request timeout.';
                            break;
                        default:
                            errorMsg += 'Unknown error.';
                    }
                    
                    showToast(errorMsg, 'error');
                },
                options
            );

            console.log('Location tracking started with watch ID:', state.locationWatchId);
        }

        /**
         * Stop tracking location
         */
        function stopLocationTracking() {
            if (state.locationWatchId !== null) {
                navigator.geolocation.clearWatch(state.locationWatchId);
                state.locationWatchId = null;
                console.log('Location tracking stopped');
            }
        }

        /**
         * Update online status in Firestore
         * @param {boolean} isOnline - Online status
         */
        async function updateOnlineStatus(isOnline) {
            if (!auth.currentUser) return;

            try {
                const deliveryManRef = doc(db, 'deliveryMen', auth.currentUser.uid);
                await updateDoc(deliveryManRef, {
                    isOnline: isOnline,
                    lastStatusUpdate: serverTimestamp()
                });

                console.log('Online status updated:', isOnline);
            } catch (error) {
                console.error('Error updating online status:', error);
                showToast('Failed to update status', 'error');
            }
        }

        /**
         * Theme Toggle - Light/Dark Mode (Profile Modal)
         */
        // Theme toggle button click handler (Profile Modal)
        ui.profileThemeToggle?.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            console.log('üé® Theme toggled to:', isDark ? 'dark' : 'light');
            
            // Refresh Lucide icons after theme change
            lucide.createIcons();
            
            showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled', 'info');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (state.isOnline) {
                stopLocationTracking();
                // Use sendBeacon for reliable status update on page close
                if (auth.currentUser && navigator.sendBeacon) {
                    const data = JSON.stringify({
                        isOnline: false,
                        lastStatusUpdate: new Date().toISOString()
                    });
                    // Note: This is a best-effort approach
                    updateOnlineStatus(false).catch(console.error);
                }
            }
        });
        
        function getStatusInfo(status) {
            switch (status) {
                case 'out-for-delivery': return { color: 'border-orange-500', text: 'Out for Delivery', bg: 'bg-orange-50 dark:bg-orange-900/20' };
                case 'delivered': return { color: 'border-green-500', text: 'Delivered', bg: 'bg-green-50 dark:bg-green-900/20' };
                default: return { color: 'border-blue-500', text: 'Processing', bg: 'bg-blue-50 dark:bg-blue-900/20' };
            }
        }

        // ===== SMS NOTIFICATION SYSTEM =====
        
        /**
         * Initialize SMS notification listener
         */
        function initializeNotifications() {
            if (!auth.currentUser) return;
            
            console.log('üîî Initializing SMS notifications for:', auth.currentUser.uid);
            console.log('üîî User UID:', auth.currentUser.uid);
            
            // Query messages for this delivery person from deliveryActivity
            const notificationsQuery = query(
                collection(db, 'deliveryActivity'),
                where('personId', '==', auth.currentUser.uid),
                where('type', '==', 'sms')
            );
            
            console.log('üîî Query created, setting up listener...');
            
            // Real-time listener
            state.unsubscribeNotifications = onSnapshot(notificationsQuery, (snapshot) => {
                console.log('üì¨ Notification snapshot received:', snapshot.size, 'messages');
                console.log('üì¨ Snapshot empty?', snapshot.empty);
                
                const messages = [];
                let unreadCount = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('üìß Message:', doc.id, data);
                    messages.push({ id: doc.id, ...data });
                    if (!data.read) unreadCount++;
                });
                
                console.log('üìä Total messages:', messages.length, 'Unread:', unreadCount);
                
                // Sort by timestamp (newest first)
                messages.sort((a, b) => {
                    if (!a.timestamp) return 1;
                    if (!b.timestamp) return -1;
                    return b.timestamp.toMillis() - a.timestamp.toMillis();
                });
                
                state.unreadCount = unreadCount;
                updateNotificationBadge(unreadCount);
                displayNotifications(messages);
                
                // Show emergency banner if there are unread messages
                if (unreadCount > 0) {
                    ui.emergencyBanner.classList.remove('hidden');
                } else {
                    ui.emergencyBanner.classList.add('hidden');
                }
                
                // Play sound for new unread messages (only after first load)
                if (!state.isFirstLoad && unreadCount > 0) {
                    playNotificationSound();
                }
            }, (error) => {
                console.error('‚ùå Notification listener error:', error);
                console.error('‚ùå Error code:', error.code);
                console.error('‚ùå Error message:', error.message);
            });
        }
        
        /**
         * Update notification badge
         */
        function updateNotificationBadge(count) {
            if (count > 0) {
                ui.notificationBadge.textContent = count > 99 ? '99+' : count;
                ui.notificationBadge.style.opacity = '1';
                ui.notificationBadge.style.pointerEvents = 'auto';
            } else {
                ui.notificationBadge.style.opacity = '0';
                ui.notificationBadge.style.pointerEvents = 'none';
            }
        }
        
        /**
         * Display notifications in modal
         */
        function displayNotifications(messages) {
            const container = ui.notificationMessages;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-300 dark:text-gray-600"></i>
                        <p>No messages yet</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Just now';
                const isRead = msg.read;
                
                return `
                    <div class="p-3 sm:p-4 ${!isRead ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-white dark:bg-gray-800'} hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-base">
                                    A
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-800 dark:text-gray-200 text-sm sm:text-base">Admin</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${time}</p>
                                </div>
                            </div>
                            ${!isRead ? '<span class="px-2 py-1 bg-blue-600 text-white text-xs rounded-full whitespace-nowrap">New</span>' : ''}
                        </div>
                        <div class="ml-0 sm:ml-12 mb-3">
                            <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap text-sm sm:text-base break-words">${msg.message}</p>
                        </div>
                        <div class="ml-0 sm:ml-12 flex flex-wrap gap-2">
                            ${!isRead ? `
                                <button onclick="markMessageAsRead('${msg.id}')" class="px-2.5 py-1.5 sm:px-3 sm:py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-xs sm:text-sm rounded transition-colors flex items-center gap-1">
                                    <i data-lucide="check" class="w-3 h-3"></i>
                                    <span class="hidden sm:inline">Mark Read</span>
                                    <span class="sm:hidden">Read</span>
                                </button>
                            ` : ''}
                            <button onclick="openReplyModal('${msg.id}')" class="px-2.5 py-1.5 sm:px-3 sm:py-2 bg-green-600 hover:bg-green-700 text-white text-xs sm:text-sm rounded transition-colors flex items-center gap-1">
                                <i data-lucide="reply" class="w-3 h-3"></i>
                                <span>Reply</span>
                            </button>
                            <button onclick="callAdmin()" class="px-2.5 py-1.5 sm:px-3 sm:py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm rounded transition-colors flex items-center gap-1">
                                <i data-lucide="phone" class="w-3 h-3"></i>
                                <span class="hidden sm:inline">Call</span>
                                <span class="sm:hidden">üìû</span>
                            </button>
                            <button onclick="deleteMessage('${msg.id}')" class="px-2.5 py-1.5 sm:px-3 sm:py-2 bg-red-600 hover:bg-red-700 text-white text-xs sm:text-sm rounded transition-colors flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                <span class="hidden sm:inline">Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        /**
         * Mark message as read
         */
        window.markMessageAsRead = async (messageId) => {
            try {
                await updateDoc(doc(db, 'deliveryActivity', messageId), {
                    read: true
                });
                showToast('Message marked as read', 'success');
            } catch (error) {
                console.error('Error marking as read:', error);
                showToast('Failed to mark as read', 'error');
            }
        };
        
        /**
         * Call admin back
         */
        window.callAdmin = () => {
            window.location.href = 'tel:01863205976';
        };
        
        /**
         * Delete message
         */
        window.deleteMessage = async (messageId) => {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }
            
            try {
                const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                await deleteDoc(doc(db, 'deliveryActivity', messageId));
                showToast('Message deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting message:', error);
                showToast('Failed to delete message', 'error');
            }
        };
        
        /**
         * Open reply modal
         */
        window.openReplyModal = (messageId) => {
            state.currentReplyMessageId = messageId;
            ui.replyModal.classList.remove('hidden');
            ui.replyModal.style.display = 'flex';
            ui.replyMessage.value = '';
            updateCharCount();
            ui.replyMessage.focus();
        };
        
        /**
         * Close reply modal
         */
        function closeReplyModal() {
            ui.replyModal.classList.add('hidden');
            ui.replyModal.style.display = 'none';
            state.currentReplyMessageId = null;
            ui.replyMessage.value = '';
        }
        
        /**
         * Update character count
         */
        function updateCharCount() {
            const count = ui.replyMessage.value.length;
            ui.replyCharCount.textContent = count;
            
            if (count > 300) {
                ui.replyCharCount.classList.add('text-red-500');
            } else {
                ui.replyCharCount.classList.remove('text-red-500');
            }
        }
        
        /**
         * Send reply to admin
         */
        async function sendReply() {
            const message = ui.replyMessage.value.trim();
            
            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }
            
            if (message.length > 300) {
                showToast('Message too long (max 300 characters)', 'error');
                return;
            }
            
            try {
                const { addDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                
                // Add reply to deliveryActivity as admin response
                await addDoc(collection(db, 'deliveryActivity'), {
                    personId: 'admin',
                    personName: state.currentUserData?.name || auth.currentUser.email,
                    phone: state.currentUserData?.phone || '',
                    adminId: auth.currentUser.uid,
                    message: message,
                    timestamp: serverTimestamp(),
                    type: 'delivery_reply',
                    read: false,
                    replyTo: state.currentReplyMessageId
                });
                
                // Mark original message as read
                if (state.currentReplyMessageId) {
                    await updateDoc(doc(db, 'deliveryActivity', state.currentReplyMessageId), {
                        read: true
                    });
                }
                
                closeReplyModal();
                showToast('Reply sent to Admin successfully!', 'success');
            } catch (error) {
                console.error('Error sending reply:', error);
                showToast('Failed to send reply: ' + error.message, 'error');
            }
        }
        
        // Event Listeners for Notification System
        ui.notificationBell?.addEventListener('click', () => {
            ui.notificationModal.classList.remove('hidden');
            ui.notificationModal.style.display = 'flex';
        });
        
        ui.closeNotificationModal?.addEventListener('click', () => {
            ui.notificationModal.classList.add('hidden');
            ui.notificationModal.style.display = 'none';
        });
        
        // Close modal on outside click
        ui.notificationModal?.addEventListener('click', (e) => {
            if (e.target === ui.notificationModal) {
                ui.notificationModal.classList.add('hidden');
                ui.notificationModal.style.display = 'none';
            }
        });
        
        // Reply Modal Event Listeners
        ui.closeReplyModal?.addEventListener('click', closeReplyModal);
        ui.cancelReplyBtn?.addEventListener('click', closeReplyModal);
        ui.sendReplyBtn?.addEventListener('click', sendReply);
        ui.replyMessage?.addEventListener('input', updateCharCount);
        
        // Close reply modal on outside click
        ui.replyModal?.addEventListener('click', (e) => {
            if (e.target === ui.replyModal) {
                closeReplyModal();
            }
        });

        // Initialize the app
        lucide.createIcons();

    </script>
</body>
</html>
